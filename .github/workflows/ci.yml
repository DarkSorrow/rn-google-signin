name: CI and Publish

on:
  push:
    branches: [ main, develop ]  # Run CI tests on every push
  pull_request:
    branches: [ main ]           # Run CI tests on PRs
  release:
    types: [published]           # Run CI tests + publish on releases

jobs:
  # Setup and validation job
  setup:
    name: Setup and Validate
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get-version.outputs.version }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'  # Initialize Git submodules for iOS dependencies
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'yarn'
      
      - name: Install Dependencies
        run: yarn install --frozen-lockfile
      
      - name: Validate package.json
        run: |
          echo "Validating package.json configuration..."
          
          # Extract and validate the 'files' field
          FILES=$(node -p "JSON.stringify(require('./package.json').files || [])")
          echo "Files included in package: $FILES"
          
          # Check for required files/directories in package.json
          for REQUIRED in "src" "android" "ios" "expo-plugin" "*.podspec"; do
            if ! echo "$FILES" | grep -q "$REQUIRED"; then
              echo "⚠️ Warning: '$REQUIRED' might be missing from package.json 'files' field"
            fi
          done
          
          # Validate Turbo Module configuration
          CODECONFIG=$(node -p "JSON.stringify(require('./package.json').codegenConfig || {})")
          echo "Codegen configuration: $CODECONFIG"
          
          if ! echo "$CODECONFIG" | grep -q "RnGoogleSigninSpec"; then
            echo "❌ Error: Codegen config name should be 'RnGoogleSigninSpec'!"
            exit 1
          fi
          
          if ! echo "$CODECONFIG" | grep -q "modules"; then
            echo "❌ Error: Codegen config type should be 'modules'!"
            exit 1
          fi
          
          if ! echo "$CODECONFIG" | grep -q "src"; then
            echo "❌ Error: Codegen config jsSrcsDir should be 'src'!"
            exit 1
          fi
          
          echo "✅ Package configuration validated"
      
      - name: Get version from release or package.json
        id: get-version
        run: |
          # If this is triggered by a release, use the release tag
          if [[ "${{ github.event_name }}" == "release" ]]; then
            VERSION="${{ github.event.release.tag_name }}"
            VERSION="${VERSION#v}"  # Remove 'v' prefix
            echo "Version from release: $VERSION"
          # Otherwise use package.json version
          else
            VERSION=$(node -p "require('./package.json').version")
            echo "Version from package.json: $VERSION"
          fi
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Using version: $VERSION"
      
      - name: Upload Repository State
        uses: actions/upload-artifact@v4
        with:
          name: repo-state
          path: .
          retention-days: 1

  # Code Quality: TypeScript compilation and ESLint
  code-quality:
    name: Code Quality Check
    needs: setup
    runs-on: ubuntu-latest
    steps:
      - name: Download Repository
        uses: actions/download-artifact@v4
        with:
          name: repo-state
          path: .
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
      
      - name: Install Dependencies
        run: npm ci
      
      - name: Run Code Quality Checks
        run: npm test
        
      - name: Validate Turbo Module Spec
        run: |
          echo "Checking Turbo Module specification..."
          
          # Check that the spec file exists
          if [ ! -f "src/NativeRnGoogleSignin.ts" ]; then
            echo "❌ Turbo Module spec file missing!"
            exit 1
          fi
          
          # Check that it exports TurboModule interface
          if ! grep -q "extends TurboModule" "src/NativeRnGoogleSignin.ts"; then
            echo "❌ Turbo Module spec doesn't extend TurboModule interface!"
            exit 1
          fi
          
          # Check that it uses TurboModuleRegistry.getEnforcing
          if ! grep -q "TurboModuleRegistry.getEnforcing" "src/NativeRnGoogleSignin.ts"; then
            echo "❌ Turbo Module spec doesn't use TurboModuleRegistry.getEnforcing!"
            exit 1
          fi
          
          # Check that iOS implementation is pure Turbo Module (no bridge patterns)
          if [ -f "ios/RnGoogleSignin.mm" ]; then
            echo "❌ iOS still has old bridge interface file (RnGoogleSignin.mm)!"
            exit 1
          fi
          
          echo "✅ Turbo Module specification validated"

  # Build and validate iOS setup
  test-ios-setup:
    name: Test iOS Setup
    needs: setup
    runs-on: macos-15  # Use macOS 15 explicitly to avoid migration issues
    steps:
      - name: Download Repository
        uses: actions/download-artifact@v4
        with:
          name: repo-state
          path: .
      
      - name: Restore file permissions
        run: |
          chmod +x scripts/*.sh 2>/dev/null || true
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
      
      - name: Install Dependencies
        run: npm ci
      
      - name: Test iOS Dependencies Setup
        run: |
          # Check if iOS Google Sign-In submodule is present
          if [ -d "ios_google" ]; then
            echo "✅ iOS GoogleSignIn submodule present"
            
            # Verify the submodule has the required files
            if [ ! -f "ios_google/GoogleSignIn.podspec" ]; then
              echo "❌ GoogleSignIn podspec not found!"
              exit 1
            fi
            
            echo "✅ iOS dependencies setup validated"
          else
            echo "⚠️ iOS submodule not present, but this is expected in CI artifact downloads"
            echo "✅ iOS dependencies setup script exists and is executable"
            
            # Test that the script exists and has the right content
            if [ ! -f "./scripts/setup_ios_google_submodule.sh" ]; then
              echo "❌ iOS setup script not found!"
              exit 1
            fi
            
            if ! grep -q "GoogleSignIn-iOS" "./scripts/setup_ios_google_submodule.sh"; then
              echo "❌ iOS setup script doesn't contain GoogleSignIn setup!"
              exit 1
            fi
            
            echo "✅ iOS setup script validated"
          fi
      
      - name: Validate iOS Podspec
        run: |
          # Check if the podspec exists and contains required sections
          if [ ! -f "RnGoogleSignin.podspec" ]; then
            echo "❌ RnGoogleSignin.podspec not found"
            exit 1
          fi
          
          # Validate podspec content
          if grep -q "s.dependency.*GoogleSignIn" RnGoogleSignin.podspec && 
             grep -q "install_modules_dependencies" RnGoogleSignin.podspec; then
            echo "✅ Podspec contains required dependencies and Turbo Module setup"
          else
            echo "❌ Podspec is missing required sections"
            exit 1
          fi

  # Build and validate Android setup  
  test-android-setup:
    name: Test Android Setup
    needs: setup
    runs-on: ubuntu-latest
    steps:
      - name: Download Repository
        uses: actions/download-artifact@v4
        with:
          name: repo-state
          path: .
      
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
      
      - name: Install Dependencies
        run: npm ci
      
      - name: Validate Android Module
        run: |
          # Check Android source files exist
          if [ ! -f "android/src/main/java/com/novastera/rngooglesignin/RnGoogleSigninModule.kt" ]; then
            echo "❌ Android module source not found!"
            exit 1
          fi
          
          if [ ! -f "android/src/main/java/com/novastera/rngooglesignin/RnGoogleSigninPackage.kt" ]; then
            echo "❌ Android package source not found!"
            exit 1
          fi
          
          # Check that Android package uses BaseReactPackage for Turbo Modules
          if ! grep -q "BaseReactPackage" "android/src/main/java/com/novastera/rngooglesignin/RnGoogleSigninPackage.kt"; then
            echo "❌ Android package doesn't use BaseReactPackage!"
            exit 1
          fi
          
          # Check that iOS doesn't use old bridge patterns
          if grep -q "RCT_EXTERN_MODULE" "ios/RnGoogleSignin.swift" || grep -q "RCTBridgeModule" "ios/RnGoogleSignin.swift"; then
            echo "❌ iOS implementation still uses old bridge patterns!"
            exit 1
          fi
          
          # Check that iOS implements the generated spec
          if ! grep -q "NativeRnGoogleSigninSpec" "ios/RnGoogleSignin.swift"; then
            echo "❌ iOS doesn't implement the generated Turbo Module spec!"
            exit 1
          fi
          
          # Check build.gradle uses proper dependency management (gradle.properties or safeExtGet)
          if ! grep -q "safeExtGet" android/build.gradle; then
            echo "❌ Android build.gradle doesn't use proper dependency management!"
            exit 1
          fi
          
          echo "✅ Android setup validated"

  # Test Expo plugin
  test-expo-plugin:
    name: Test Expo Plugin
    needs: setup
    runs-on: ubuntu-latest
    steps:
      - name: Download Repository
        uses: actions/download-artifact@v4
        with:
          name: repo-state
          path: .
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
      
      - name: Install Dependencies
        run: npm ci
      
      - name: Build Expo Plugin Only
        run: npm run prepare
      
      - name: Validate Plugin Build
        run: |
          if [ ! -f "lib/module/index.js" ]; then
            echo "❌ Module build failed!"
            exit 1
          fi
          
          if [ ! -f "lib/typescript/src/index.d.ts" ]; then
            echo "❌ TypeScript build failed!"
            exit 1
          fi
          
          echo "✅ Module built successfully"
          echo "Build contents:"
          ls -la lib/
          
          # Test that module exports are correct
          echo "Testing module exports..."
          node -e "
            try {
              const module = require('./lib/module/index.js');
              console.log('✅ Module exports validated');
              console.log('Available exports:', Object.keys(module));
            } catch (e) {
              console.error('❌ Module exports failed:', e.message);
              process.exit(1);
            }
          "

  # Successful CI check
  ci-success:
    name: CI Success
    needs: [setup, code-quality, test-ios-setup, test-android-setup, test-expo-plugin]
    runs-on: ubuntu-latest
    if: ${{ always() }}
    steps:
      - name: Check Status
        run: |
          if [ "${{ needs.setup.result }}" = "success" ] && 
             [ "${{ needs.code-quality.result }}" = "success" ] && 
             [ "${{ needs.test-ios-setup.result }}" = "success" ] && 
             [ "${{ needs.test-android-setup.result }}" = "success" ] && 
             [ "${{ needs.test-expo-plugin.result }}" = "success" ]; then
            echo "✅ All CI checks passed!"
            exit 0
          else
            echo "❌ One or more CI checks failed!"
            echo "Setup: ${{ needs.setup.result }}"
            echo "Code Quality: ${{ needs.code-quality.result }}"
            echo "iOS Setup: ${{ needs.test-ios-setup.result }}"
            echo "Android Setup: ${{ needs.test-android-setup.result }}"
            echo "Expo Plugin: ${{ needs.test-expo-plugin.result }}"
            exit 1
          fi

  # Publish to NPM - only runs when you manually create a GitHub release
  publish:
    name: Publish to NPM
    if: github.event_name == 'release' && github.event.action == 'published'
    needs: [ci-success]
    runs-on: ubuntu-latest
    steps:
      - name: Download Repository
        uses: actions/download-artifact@v4
        with:
          name: repo-state
          path: .
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          registry-url: 'https://registry.npmjs.org'
      
      - name: Install Dependencies
        run: npm ci
      
      - name: Extract version from release tag
        id: get-version
        run: |
          # Extract version from the release tag (remove 'v' prefix if present)
          VERSION="${{ github.event.release.tag_name }}"
          VERSION="${VERSION#v}"  # Remove 'v' prefix
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Publishing version: $VERSION"
          
          # Validate semver format
          if [[ ! "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.]+)?$ ]]; then
            echo "❌ Error: Version '$VERSION' does not follow semver format x.y.z(-suffix)"
            exit 1
          else
            echo "✅ Version '$VERSION' follows semver format"
          fi
      
      - name: Update version in package.json
        run: |
          VERSION=${{ steps.get-version.outputs.version }}
          CURRENT_VERSION=$(node -p "require('./package.json').version")
          
          echo "Target version: $VERSION"
          echo "Current version: $CURRENT_VERSION"
          
          if [ "$VERSION" = "$CURRENT_VERSION" ]; then
            echo "✅ Version is already correct ($VERSION), no update needed"
          else
            echo "Updating version from $CURRENT_VERSION to $VERSION"
            npm version "$VERSION" --no-git-tag-version
            echo "✅ Version updated successfully"
          fi
      
      - name: Build package
        run: |
          # Build using react-native-builder-bob
          npm run prepare
          
          # Verify the build output
          if [ ! -d "lib" ] || [ ! "$(ls -A lib 2>/dev/null)" ]; then
            echo "❌ Build failed - lib directory is empty or missing"
            exit 1
          fi
          
          echo "✅ Build completed successfully"
          echo "Built lib contents:"
          ls -la lib/
      
      - name: Verify package content
        run: |
          echo "Checking files to be included in the package..."
          
          # Verify core files and directories exist
          for REQUIRED in "src" "android" "ios" "lib" "RnGoogleSignin.podspec"; do
            if [ ! -e "$REQUIRED" ]; then
              echo "❌ Required file/directory '$REQUIRED' is missing!"
              exit 1
            else
              echo "✅ Found: $REQUIRED"
            fi
          done
          
          # Verify Turbo Module spec exists
          if [ ! -f "src/NativeRnGoogleSignin.ts" ]; then
            echo "❌ Turbo Module spec file missing!"
            exit 1
          fi
          
          echo "✅ Turbo Module spec verified"
          
          # Verify iOS submodule is present (should be from artifacts)
          if [ ! -d "ios_google" ]; then
            echo "⚠️ Warning: iOS GoogleSignIn submodule not found in package"
          else
            echo "✅ iOS GoogleSignIn submodule present"
          fi
          
          echo "✅ Package content verification completed"
      
      - name: Publish to NPM
        run: npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_SECRET }} 